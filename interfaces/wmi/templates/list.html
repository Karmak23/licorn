{#- Copyright 2011 META IT & Robin Lucbernet<rl@meta-it.fr>
    Distributed under the terms of the GNU GPL version 2. -#}

{#- REMOVE IT -#}
{% from 'widgets/common.html' import licorn_list, jquery_popover_media with context %}

{%- extends 'template_one_content.html' -%}

{%- block extended_media -%}
	<link rel="stylesheet" type="text/css" media="screen,projection" href="/media/css/licorn_table.css" />
	<script language="javascript" type="text/javascript" src="/media/js/jquery.uitablefilter.js"></script>
	<script language="javascript" type="text/javascript" src="/media/js/jquery.iselectable.js"></script>
	<script language="javascript" type="text/javascript" src="/media/js/sortabletable.js"></script>
	<script language="javascript" type="text/javascript" src="/media/js/jquery.tablescroll.js"></script>

	<link rel="stylesheet" type="text/less" media="screen,projection" href="/media/css/ug-popover.css" />
	


{%- endblock -%}

{%- block title -%} {%- endblock -%}

{%- block main_content -%}
	<div class="modal hide fade" id="modal">

		{{ modal_html }}
	</div>

	<div class='table_header row-fluid'>
		<span id="table_header_title" class="span2">
			{%- block list_title -%}
			{%- endblock -%}
		</span>

		<span id="table_header_massive_actions" class='span3'>
			<div class="centered">&nbsp;</div>
			<div class="centered">
				
				{%- block massive_actions -%}
				{%- endblock -%}
				
			</div>
		</span>


		<span id="table_header_filter" class='span2'>
			<div class="centered">&nbsp;</div>
			<div class="centered" id='list_filter'>
				
				{%- block list_filters -%}
				{%- endblock -%}
				
			</div>
		</span>

		<span id="table_header_search" class='span3'>
			<div class="centered">&nbsp;</div>
			<div class="input-prepend" >
				<span class="add-on"><i class="icon-search"></i></span>
				<input class="input-large" type='text' accesskey="f" id="list_search"/>
			</div>
		</span>
	</div>

	<table class="table sortable" id="model_groups_table">
		<thead>
			<tr>
				{%- block list_headers -%}
				{%- endblock -%}
			</tr>
		</thead>
		<tbody id='table_tbody'>
			{%- block list_body -%}
			{%- endblock -%}
		</tbody>
	</table>

	<script language="javascript" type="text/javascript">
		$(document).ready(function() {

			// setup the list
			var START_TIME = new Date().getTime();
			
			setup_list();
			
			var END_TIME = new Date().getTime();
			totalTime = (END_TIME - START_TIME);
			console.log("total time to setup list", totalTime);


			{%- if modal_html -%} 
				// if modal_html is activated, prompt it!
				$("#modal").modal();
			{%- endif -%}
		});

		function groups_doubleclick_row(td) {
			// what happens when a row has been double clicked,
			// show the edit form.

			if (! $(td).hasClass('no_double_click')) {

				gid = td.data('gid')

				if (gid == null) {
					gid = td.parent('.licorn_row').data('gid')
				}

				$.get('/groups/edit/'+gid, function(modal_html) {
					$("#modal").html(modal_html).modal()
				})
			}
		}
		
		function my_setup_table_search() {
			// setup a timer in order to let the user type several letter 
			// in the search filed before really search 
			var search_timeout;
			searchbox=$('#list_search')

			searchbox.keyup(function() {

				// clear the timer
				clearTimeout(search_timeout)
				search_timeout = setTimeout( function() {

					// get the value to search
					val = searchbox.val()

					// do not search through 'filtered' rows
					$('.filtered:not(.hidden)').addClass('hidden');
					
					if (val == '') {
						$('.not_filtered').css('display', '').removeClass('hidden')
						$('.filtered').removeClass('hidden')
					}
					else {
						$('.not_filtered:not(:contains('+val+'))').css('display', 'none').addClass('hidden')
						$('.not_filtered:contains('+val+')').css('display', '').removeClass('hidden')
						
					}
					
				}, 500);

			})
		}

		// filters used to filter the table
		var filters = { 'standard' : true, 'system': true, 'restricted': false, 'privileged': true}
		// sortableTable object
		var st;
		
		function setup_list(list_name) {
			// search field
			my_setup_table_search()

			// make rows selectable
			setup_table_row_selectable($('#model_groups_table tbody'), select_active_class, '.not-me');

			// filters btn
			setup_table_filter($('#model_groups_table tbody tr'), $('.filter_item'), filters)

			// setup doubleclick on each rows
			setup_table_row_doubleclick($('#model_groups_table tbody td'), groups_doubleclick_row);
			
			// setup the sort plugin
			// PERF ISSUE
			//setup_table_sorter();

			/*table=$('table.sortable');
			table.tablesorter( {
				// for performance issue, do not sort the list on load
				//sortList:[[2,0]],
			})
			table[0].config.sortList = [[2,0]]*/

			st = new SortableTable(document.getElementById("model_groups_table"),
				["None", "None", "Name", "Description", "gid", "skel"])
			
			// setup default sort state
			$('#model_groups_table').attr('data-sort-col', 2)
			$('.table_column_header').each(function(i, header) {
				$(header).attr('data-sort-col', i)
				$(header).attr('data-sort-way', 0)
			})
			$('.table_column_header').click(function() {
				// set new context
				_THIS = $(this)
				current_way = _THIS.attr('data-sort-way')
				if (current_way == 1) {
					new_way = 0;
				}
				else {
					new_way = 1;
				}
				
				_THIS.attr('data-sort-way', new_way)
				$('#model_groups_table').attr('data-sort-col', _THIS.data('sort-col'))

				loading_animation_func(gettext('Please wait while sorting list'));
				
				tim = setTimeout( function() {

					st.sort(_THIS.attr('data-sort-col'), new_way)
					remove_loading_animation();
				}, 500);


				
			})


			/*table.on("sortStart",function() {
				$("#wait").show();
				console.log("start")
			}).on("sortEnd",function() {
				$("#wait").hide();

				console.log("stop")
			});*/

			// setup active sort
			//$($('.table_column_header').get(2)).addClass('headerSortDown')



			//massives actions
			setup_massive_actions();

			setup_hover();

			// Is this still used ?
			//setup_ajaxized_link($('#model_groups_table tbody td'));

			// PERF ISSUE
			//$('.licorn_tooltip').tooltip()
		}

		// to move in common.js
		function setup_table_filter(table_rows, items, filters) {
			/* setup table filters */

			$.each(items, function(i, item) {
				// setup interface
				if (filters[$(item).data('filter')]) {
					$(item).addClass('active')
				}
				else {
					$(item).removeClass('active')
				}
			})

			$(items).click(function() {
				// check the filter state
				if ($(this).hasClass('active')) {
					// the filter is currently activated, disable it
					$(this).removeClass('.active');
					filters[$(this).data('filter')] = false;
				}
				else {
					// set the filter as active
					$(this).addClass('.active')
					filters[$(this).data('filter')] = true;
				}
				do_filter();
			})

			do_filter();

			function do_filter() {
				/* really do the filter, show/hide rows */
				$.each(filters, function(name, on_state) {
					filter_items = $('#table_tbody .filter_'+name+'')
					if (on_state) {
						filter_items.addClass('not_filtered').removeClass('filtered').css('display', '')
					}
					else {
						filter_items.removeClass('not_filtered').addClass('filtered').css('display', 'none');
					}
				})
			}
		}
		function setup_ajaxized_link(items) {
			items.find('.ajaxized_link').click(function() {
				$.get($(this).attr('href'))
				return false;
			})
		}
		function setup_massive_actions() {
			$('.massive_action').click(function() {
				// get selected items
				selected_rows = get_selected_rows($('#model_groups_table tbody'), select_active_class);
				
				action_name = $(this).data('name')
				action_url = $(this).data('url')

				if (selected_rows.length == 0) {
					show_message_through_notification('{{ _("Please select at least one group to apply massive action <strong><em>'+action_name+'</em></strong> on") }}');
				}
				else {
					gids=[]
					$.each(get_selected_rows($('#model_groups_table tbody'), select_active_class), function(i, item) {
						gids.push($(item).data('gid'))
					})

					// get the massive selection template
					url = '/groups/massive_select_template/'+action_name+'/'+gids.join(',')
					//console.log(url);
					$.get(url, function(modal_html) {
						$("#modal").html(modal_html).modal()
						init_massive_select_events(action_name, action_url, gids);
					})
				}
			})
		}
		function init_massive_select_events(action_name, action_url, gids) {
			//console.log("init_massive_select_events", action_name, action_url, gids)
			$('#apply_massive_action').click(function() {
				// close the modal
				$("#machine_modal").modal('hide')

				// run the action
				if (action_name == 'export') {
					$.get(action_url + gids, function(data) {
						file_name = data.file_name
						iframe = document.getElementById('download_iframe')
						iframe.src = "/system/download/"+file_name

					}, "json")
				}
				else {
					$.get(action_url + gids)
				}

				// unselect all rows
				$('.row_selected').removeClass('row_selected')
				//hide the modal
				$('#modal').modal('hide')

			})
		}
		function setup_hover() {
			// on row hover, always clean interface in case of previus preselection with keyboard
			$('#model_groups_table tbody tr').hover(function(){
				//in
				//$('#model_groups_table tr').css({"background-color":"none"})
				// change the background color to preselect it
				$(this).css({'background-color': background_color_hover})

				$('.preselected_row').removeClass('preselected_row').css({"background-color":"none"})
				//$(this).addClass('preselected_row')

			}, function() {
				//out
				$(this).css({'background-color': "none"})
			})
		}

		var select_active_class = 'row_selected'
		var background_color_hover = 'rgb(245, 245, 245)'
		
		// timer used to prevent massive operation to be ran several times
		var setup_row_timeout;

		function setup_row(row, old) {
			// function called when a new row is inserted (not already displayed) into the table.
			console.log('setup_row', row, old)

			// apply events
			setup_table_row_doubleclick($(row), groups_doubleclick_row)

			// because this method can be ran several times in a short period, 
			// TRY to run these massive operations once.
			clearTimeout(setup_row_timeout)
			setup_row_timeout = setTimeout( function() {
				// make rows selectable
				setup_table_row_selectable($('#model_groups_table tbody'), select_active_class, '.not-me')
				// setup hover animation
				setup_hover();
				

				
				
				
				// sort the list
				// 4356
				// ff : 640
				col = $('#model_groups_table').data('sort-col')
				
				loading_animation_func(gettext('Please wait while sorting list'));
				
				tim = setTimeout( function() {
					var sort_START_TIME = new Date().getTime();
					
					current_way = $($('.table_column_header').get(parseInt(col))).attr('data-sort-way')
					st.sort(col, parseInt(current_way))
					remove_loading_animation();
					
					var sort_END_TIME = new Date().getTime();
					totalSortTime = (sort_END_TIME - sort_START_TIME);
					console.log("total time to sort list", totalSortTime);
				}, 500);



				// second method
				// 6796 ; 7500
				// ff : 1200
				/*$('#model_groups_table')
					//
					.trigger('update')
					//.trigger("sorton", [[[2,0]]])
					//.trigger('appendCache')*/




				
			}, 500);


			// check the table context (search and filters) before showing the row
			if (filters[get_row_filter($(row))] && does_row_match_search($(row))) {
				$(row).addClass('not_filtered').show();
			}
			else {
				console.log('row not matching table context')
				$(row).addClass('filtered')
			}

			$(row).css('display', '')




			//setup_ajaxized_link($(row))

			//$('.licorn_tooltip').tooltip()
			
		}
		function get_row_filter(row) {
			var found;
			$.each(filters, function(filter) {
				console.log(filter)
				if ($(row).hasClass('filter_'+filter)) {
					console.log('filter found ', filter)
					found = filter
				}
			
			})
			return found

		}
		function does_row_match_search(row) {
			search_val = $('#list_search').val()

			if (search_val == '') {
				return true;
			}
			else if ($(row).text().indexOf(search_val) != -1) {
				return true;
			}
			else {
				return false
			}
		}

















	
		function bind_hotkeys() {
			/* Bind all hotkeys

				- J/K : preselect previus/following row
				- S : select/unselect a preselected row

				- N : add a new group

				- ENTER :
					- if modal is not visible : edit/mass edit selected row(s)

				if modal not visible and searchbox not focused :
					- SUPPR / DELETE : massive delete operation on selected row(s)
					- L : massive reapply skel to groups' members operation on selected row(s)
					- X : massive export operation on selected row(s)
					- p : massive toggle permissive operation on selected row(s)
				
				- ESCAPE : (in order)
					- if modal visible : hide the modal
					- if searchbox focused : unfocus it
					- if row(s) selected : unselect it

				NOTE : we are catching keyup and keypressed
			*/

			// cache selectors used
			searchb = $('#list_search');
			modal = $('#modal')


			$(document).keyup(function(e) {
				console.log("keyup", e.which )

				if (e.which == 8 || e.which == 46) {    // SUPPR => mass delete
					if (! searchb.is(':focus') && modal.is(':hidden')) {
						$('#massive_delete').click()
					}
				}

				if (e.which == 27) {    // ESC
					// on ESC, first hide modal is visible, secondly 
					// remove search content, thirdly unselect row

					if (modal.is(':visible')) {
						modal.modal('hide')
					}
					else if (searchb.is(':focus')) {
						searchb.val('');
						searchb.keyup();
						searchb.blur();

						e.stopPropagation();
						e.preventDefault();

					} 
					else {
						$('.row_selected').removeClass('row_selected')
					}
					

				}
				if (! searchb.is(':focus') && $('#modal').is(':hidden')) {
					
					if (e.which == 78) {    // n => new group
						console.log('toototototototo')
						$.get('/groups/new', function(html) {
							modal.html(html).modal()
						})
					}
					
				}
			});
			$(document).keypress(function(e) {

				console.log('keypress', e.which)

				/* Rows selection mecanism */
				if ( !searchb.is(':focus') && modal.is(':hidden')) {
					if (e.which == 106 || e.which == 107 || e.which == 115) {
						var preselected_row  = null;

						var next_row         = null
						var previus_row      = null
						var new_selected_row = null

						// find where to start 
						//console.log('seeking where to start')
						if ($('.preselected_row').length == 0) {

							$.each($('tbody tr'), function() {
								//console.log($(this).css('background-color'), background_color_hover, $(this).css('background-color') == background_color_hover)
								if ($(this).css('background-color') == background_color_hover) {
									preselected_row = $(this);
								}
							});
						}
						else {
							preselected_row = $('.preselected_row')
						}
					}

					if (e.which == 107) {    // K = next
						if (preselected_row == null) {
							// no, preselected row, start from the top
							new_selected_row = $('table tbody tr:first');
						}
						else {
							// one row is already preselected, start from it
							next_row = preselected_row.next(':visible')
							if (next_row.length == 0) {
								next_row = preselected_row.nextUntil(':visible').last().next()
							}
							new_selected_row = next_row;					}
					}

					if (e.which == 106) {    // J = previus
						if (preselected_row == null) {
							// no, preselected row, start from the top
							new_selected_row = $('table tbody tr:first');
						}
						else {
							// one row is already preselected, start from it
							prev_row = preselected_row.prev(':visible')
							if (prev_row.length == 0) {
								prev_row = preselected_row.prevUntil(':visible').prev().last();
							}
							new_selected_row = prev_row;
							
						}

					}
					if (e.which == 106 || e.which == 107) {
						
						if (new_selected_row.length != 0) {
							if (preselected_row != null) {
								// unpreselect preselected_row
								preselected_row.css({'background-color': "none"})
							}
							$('.preselected_row').removeClass('preselected_row')
						
							new_selected_row.addClass('preselected_row').css({'background-color' : background_color_hover})

							// scroll the body to have the selected row at the middle of the screen
							// NOTE : in chrome, selecting body is ok, but in FF we need to select html...
							$('body,html').scrollTop(new_selected_row.position().top - $(window).height() / 2)
						}
					}

					if (e.which == 115) {    // s
						if (preselected_row.hasClass(select_active_class)) {
							preselected_row.removeClass(select_active_class)
						}
						else {
							// if a row is "preselected", select it
							$('.preselected_row').removeClass('preselected_row')
							preselected_row.addClass('preselected_row').addClass(select_active_class)
						}
					}
				}
				if (e.which == 13) {    // enter
					if (modal.is(':hidden')) {
						selected_rows = get_selected_rows($('#model_groups_table tbody'), select_active_class);
						console.log($(selected_rows))
						if (selected_rows.length == 1) {
							gid = $(selected_rows).data('gid');
							$.get('/groups/edit/'+gid, function(modal_html) {
								modal.html(modal_html).modal()
							})
						}
						else if (selected_rows.length > 1) {
							$('#massive_edit').click()
						}
					}
					else {
						$('#apply_massive_action').trigger('click')
					}



				}
				
				if (! searchb.is(':focus') && $('#modal').is(':hidden')) {
					if (e.which == 112) {    // p => mass perm
						$('#massive_permissive').click()
					}
					if (e.which == 120) {    // x => mass export
						$('#massive_export').click()
					}
					if (e.which == 108) {    // l => mass skel
						$('#massive_skel').click()
					}
					if (e.which == 63 && e.shiftKey) {    // ? => help
							$.get('/groups/hotkeys_help', function(html) {
								modal.html(html).modal();
							})
						}
				}





				/* page parts selection mecanism */
				/*if (e.keyCode == 102) {    // f => focus search field
					$('#list_search').focus();
					// stop propagation and default to avoid "f" in search field
					e.preventDefault();
					e.stopPropagation();
				}*/
				//if (e.keyCode == 76 && e.shiftKey) {    // shift + l => focus list
				//	console.log('alt+l')
				//	$('#model_groups_table').focus();
				//	e.preventDefault();
				//	e.stopPropagation();
				//}

			});	

		}
	</script>


{%- endblock -%}





















