<style type="text/css">
	
.weekly_bars_wrapper {
	height: 80%;
	text-align: center;
	background-color: #fafafa;
	border-radius: 5px;
	width: 90%;
}

.weekly_bars_label {
	text-align: center;
	font-size: 80%;
}

#weekly_bars_chart {
	font: 10px sans-serif;
	font-weight: lighter;
	color: black;
	border: 1px solid black;
}

.databar {
	text-align: center;
	padding: 3px;
	margin: 1px;	
}

.scaleline {
	stroke: #ccc;
}

.dayline {
	stroke: #000;
}

.hour, .label {
	font: sans-serif;
	font-size: 11px;
	color: #580d27;
}
.day {
	border:1px solid red;
}
.rect_sep {
	fill:red;
}
.rect_on {
	fill:#BFFF00;
}
.rect_off {
	fill:#BDBDBD;
}
</style>
<div class="weekly_bars_wrapper">
	<div id="weekly_bars_chart_container"></div>
	<div class="weekly_bars_label">{{ _('Extinction calendar : allowed activity periods') }}</div>
</div>
<script language="javascript">

	// VARS 
	var total_width  = 0.9*$("#sub_content_wrapper").width()
	var total_height = 0.8*$("#sub_content_wrapper").height()

	var graph_start_x = 25

	var total_height_graph = total_height - 20
	var total_width_graph = total_width - 20

	var total_width_bar = total_width_graph / 6
	var bar_width = total_width_bar / 2

	var separator_height = 5
	var separator_width = 0.6*total_width_bar	


	// create the chart
		var wbchart = d3.select('div#weekly_bars_chart_container')
					.insert("svg:svg")
						.attr("id", "weekly_bars_chart")
						.attr("width", total_width)
						.attr("height", total_height)
						.append("svg:g");


		/*h = []
		
		
		data_separators = {{ data_separators }}

		$.each(data_separators, function(i, data) {
			//console.log(data)
			h.push(parseInt(data['hour']))
		})
		
		data_on_off = [
			{ 'on': d3.min(h)*60, 'off': d3.min(h)*60},
			{ 'on': d3.min(h)*60, 'off': d3.min(h)*60},
			{ 'on': d3.min(h)*60, 'off': d3.min(h)*60},
			{ 'on': d3.min(h)*60, 'off': d3.min(h)*60},
			{ 'on': d3.min(h)*60, 'off': d3.min(h)*60},
			{ 'on': d3.min(h)*60, 'off': d3.min(h)*60},
			{ 'on': d3.min(h)*60, 'off': d3.min(h)*60},
		]

		console.log(data_on_off)

		$.each(data_separators, function(i, data) {
			off = data_on_off[parseInt(data['day'])]['off']
			if (off == null || off < parseInt(data['hour']) * 60 + parseInt(data['minute'])) {
				data_on_off[parseInt(data['day'])]['off'] = parseInt(data['hour'])*60+parseInt(data['minute'])
				console.log('change ', off)
			}
		})

		if (d3.min(h) < 8) {
			hour_min = d3.min(h);
		} else {
			hour_min = 8;
		}

		if (d3.max(h) > 20) {
			hour_max = d3.max(h);
		} else {
			hour_max = 20;
		}



		hour_range  = d3.range(hour_min*60, (hour_max+1)*60+1, 60)

		// hour line vectors
		var hour_vect = d3.scale.linear()
		    .domain([hour_min*60, (hour_max+1)*60])
	    	.range([25, total_height_graph]);

	    // day cols vectors
	    var day_vect = d3.scale.ordinal()
			.domain([0,1,2,3,4,5,6])
			.rangeBands([35, total_width_graph]);



		 // hour line
	    hour_line = wbchart.selectAll("line_hour")
		    .data(hour_range)
		
		hour_line.enter()
		    	.append("svg:line")

				.attr("class", "line_hour")
				.attr("y1", hour_vect)
				.attr("y2", hour_vect)
				.attr("x1", 35)
				.attr("x2", total_width_graph)
				.text(String)
		    	.style("stroke", "#ccc");

		// hour text 
		hour_text = wbchart.selectAll("text.hour")
			.data(hour_range)
		hour_text.enter().append("svg:text")
			.attr("class", "hour")
			.attr("x", 25)
			.attr("y", hour_vect)
			.attr("dx", -3)
			.text(function(d){ return (d/60).toString() + 'h00'; })
			.attr("text-anchor", "middle");
		
		// DAY TEXT 
		wbchart.selectAll("text.day")
		.data([ "{{ _('Mon.') }}", "{{ _('Tue.') }}", "{{_('Wed.') }}", 
						"{{ _('Thu.') }}", "{{_('Fri.') }}", "{{_('Sat.') }}", 
						"{{_('Sun.') }}" ])
		.enter()
			.append("svg:text")
			.attr("class", "day")
			.attr("x", day_vect)
			.attr("y", 20)
			.attr("dx", function(d, i){ return total_width_bar/2.5; })
			.text(function(d, i){ return d; })

		
		
		// rect on
		rect_on = wbchart.selectAll(".rect_on").data(data_on_off)
			
		rect_on.enter()
			.append("svg:rect")
			.attr("class", "rect_on")
			.attr("x", function(d, i) { return day_vect(i) + bar_width/2 })
			
			.attr("width", bar_width)
			.attr("height", function(d) { return hour_vect(d.off) - hour_vect(hour_min*60) })
			.attr("y", function(d) { return hour_vect(hour_min*60); });

		
		
		// rect off
		rect_off= wbchart.selectAll(".rect_off").data(data_on_off)
			
		rect_off.enter()
			.append("svg:rect")
			.attr("class", "rect_off")
			.attr("x", function(d, i) { return day_vect(i) + bar_width/2 })
			
			.attr("width", bar_width)
			.attr("height", function(d) { return hour_vect((hour_max+1)*60) - hour_vect(d.off) })
			.attr("y", function(d) { console.log('off', d.off); return hour_vect(d.off); });
		
		

		// draw separators		
		separators = wbchart.selectAll(".rect_sep").data(data_separators)

		separators.enter()
			.insert("svg:rect")
			.attr("class", "rect_sep")
			.attr("x", function(d) { return day_vect(d.day) + ( total_width_bar - separator_width)/2 })
			.attr("width", separator_width)
			.attr("height", separator_height)
			.attr("y", function(d) { return hour_vect(parseInt(d.hour)*60+parseInt(d.minute)) - separator_height/2 })
		
		
		
		
		
		$('svg .rect_sep').tipsy({ 
	    	gravity: 's', 
	    	html: true, 
	    	title: function() {
	    		var d = this.__data__, g = d.who;
	    		return strargs(gettext('Extinction of %1'), [ g ]); 
	    	   }
	    }); */



	function draw_extinction_calendar(new_data_separators) {
		console.log(new_data_separators)
		h=[]
		$.each(new_data_separators, function(i, data) {
			//console.log(data)
			h.push(parseInt(data['hour']))
		})
		console.log("h ", h)
		if (d3.min(h) < 8) {
			hour_min = d3.min(h);
		} else {
			hour_min = 8;
		}

		if (d3.max(h) > 20) {
			hour_max = d3.max(h);
		} else {
			hour_max = 20;
		}

		data_on_off = [
			{ 'on': d3.min(h)*60, 'off': hour_min*60},
			{ 'on': d3.min(h)*60, 'off': hour_min*60},
			{ 'on': d3.min(h)*60, 'off': hour_min*60},
			{ 'on': d3.min(h)*60, 'off': hour_min*60},
			{ 'on': d3.min(h)*60, 'off': hour_min*60},
			{ 'on': d3.min(h)*60, 'off': hour_min*60},
			{ 'on': d3.min(h)*60, 'off': hour_min*60},
		]

		//console.log(data_on_off)

		$.each(new_data_separators, function(i, data) {
			off = data_on_off[parseInt(data['day'])]['off']
			if (off == null || off < parseInt(data['hour']) * 60 + parseInt(data['minute'])) {
				data_on_off[parseInt(data['day'])]['off'] = parseInt(data['hour'])*60+parseInt(data['minute'])
				console.log('change ', off)
			}
		})
		
		// hour line vectors
		var hour_vect = d3.scale.linear()
		    .domain([hour_min*60, (hour_max+1)*60])
	    	.range([25, total_height_graph]);
	    
	     // day cols vectors
	    var day_vect = d3.scale.ordinal()
			.domain([0,1,2,3,4,5,6])
			.rangeBands([35, total_width_graph]);

	    console.log("hour_min = ", hour_min)
	    console.log("hour_max = ", hour_max)

		hour_range  = d3.range(hour_min*60, (hour_max+1)*60+1, 60)


		 // hour line
		//remvoe old lines
		hour_line = wbchart.selectAll("line.line_hour")
		    .data(hour_range)
		

		hour_line.enter()
		    	.append("svg:line")
		    	.attr('class', 'line_hour')
				.attr("y1", hour_vect)
				.attr("y2", hour_vect)
				.attr("x1", 35)
				.attr("x2", total_width_graph)
				.text(String)
		    	.style("stroke", "#ccc");
		hour_line
			.attr("y1", hour_vect)
			.attr("y2", hour_vect)
		hour_line.exit().remove();
	

		// hour text 
		hour_text = wbchart.selectAll("text.hour")
			.data(hour_range)
		hour_text.enter().append("svg:text")
			.attr("class", "hour")
			.attr("x", 25)
			.attr("y", hour_vect)
			.attr("dx", -3)
			.text(function(d){ return (d/60).toString() + 'h00'; })
			.attr("text-anchor", "middle");
		hour_text.attr("y", hour_vect)
		hour_text.exit().remove();
		
		// DAY TEXT 
		wbchart.selectAll("text.day")
		.data([ "{{ _('Mon.') }}", "{{ _('Tue.') }}", "{{_('Wed.') }}", 
						"{{ _('Thu.') }}", "{{_('Fri.') }}", "{{_('Sat.') }}", 
						"{{_('Sun.') }}" ])
		.enter()
			.append("svg:text")
			.attr("class", "day")
			.attr("x", day_vect)
			.attr("y", 20)
			.attr("dx", function(d, i){ return total_width_bar/2.5; })
			.text(function(d, i){ return d; })

		
		
		// rect on
		rect_on = wbchart.selectAll(".rect_on").data(data_on_off)
			
		rect_on.enter()
			.append("svg:rect")
			.attr("class", "rect_on")
			.attr("x", function(d, i) { return day_vect(i) + bar_width/2 })
			
			.attr("width", bar_width)
			.attr("height", function(d) { return hour_vect(d.off) - hour_vect(hour_min*60) })
			.attr("y", function(d) { return hour_vect(hour_min*60); });

		rect_on
			.attr("height", function(d) { return hour_vect(d.off) - hour_vect(hour_min*60) })
			.attr("y", function(d) { return hour_vect(hour_min*60); });
		
		rect_on.exit().remove()
		
		// rect off
		rect_off= wbchart.selectAll(".rect_off").data(data_on_off)
			
		rect_off.enter()
			.append("svg:rect")
			.attr("class", "rect_off")
			.attr("x", function(d, i) { return day_vect(i) + bar_width/2 })
			
			.attr("width", bar_width)
			.attr("height", function(d) { return hour_vect((hour_max+1)*60) - hour_vect(d.off) })
			.attr("y", function(d) { console.log('off', d.off); return hour_vect(d.off); });
		
		rect_off
			.attr("x", function(d, i) { return day_vect(i) + bar_width/2 })
			.attr("width", bar_width)
			.attr("height", function(d) { return hour_vect((hour_max+1)*60) - hour_vect(d.off) })
			.attr("y", function(d) { return hour_vect(d.off); });
		
		rect_off.exit().remove()
		

		// draw separators		
		separators = wbchart.selectAll(".rect_sep").data(new_data_separators)

		separators.enter()
			.insert("svg:rect")
			.attr("class", "rect_sep")
			.attr("x", function(d) { return day_vect(d.day) + ( total_width_bar - separator_width)/2 })
			.attr("width", separator_width)
			.attr("height", separator_height)
			.attr("y", function(d) { return hour_vect(parseInt(d.hour)*60+parseInt(d.minute)) - separator_height/2 })
		
		separators
			.attr("class", "rect_sep")
			.attr("x", function(d) { return day_vect(d.day) + ( total_width_bar - separator_width)/2 })
			.attr("width", separator_width)
			.attr("height", separator_height)
			.attr("y", function(d) { return hour_vect(parseInt(d.hour)*60+parseInt(d.minute)) - separator_height/2 })

		separators.exit().remove()

		
		
		
		$('svg .rect_sep').tipsy({ 
	    	gravity: 's', 
	    	html: true, 
	    	title: function() {
	    		var d = this.__data__, g = d.who;
	    		return strargs(gettext('Extinction of %1'), [ g ]); 
	    	   }
	    });

	
	   

	}

	//data_separators = [{day:'2', hour:13},{day:'6', hour:13}, {day:'0', hour:13}]
	//data_on_off = [{'on':6, 'off':13}, {'on': 6, 'off':22}, {'on':6, 'off':13}, {'on': 6, 'off':22},{'on': 6, 'off':22},{'on': 6, 'off':22}, {'on':6, 'off':13} ]

	//draw_extinction_calendar([], [])	






/*

	var weekly_bars_is_ready = false;

	// global variables, they are used inside the redraw() function.
	var transition_delay = 2500;
	var transition_fast  = 1750;

	// create a global variable, start the graph with arbitrary values.
	var data_hour = [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
	var data_day = [ "{{ _('Mon.') }}", "{{ _('Tue.') }}", "{{_('Wed.') }}", 
					"{{ _('Thu.') }}", "{{_('Fri.') }}", "{{_('Sat.') }}", 
					"{{_('Sun.') }}" ]


	
	// day ==> Monday:0;...;Sunday:6
	var data_calendar = []
	
	// vectors
	var v_lines = d3.scale.linear()
		.domain([6, 22])
		.range([0, 360]);

	var v_days = d3.scale.ordinal()
		.domain(data_day)
		.rangeBands([55, 495]);

	// chart
	var wbchart = d3.select('div#weekly_bars_chart_container')
					.append("svg:svg")
						.attr("id", "weekly_bars_chart")
						.attr("width", $("#weekly_bars_wrapper").width())
						.attr("height", $("#weekly_bars_wrapper").height())
						.append("svg:g")
						.attr("transform", "translate(10, 15)");

	//first, create hour lines and add the text
	wbchart.selectAll("line.scaleline")
		.data(data_hour)
		.enter()
			.append("svg:line")
			.attr("class", "scaleline")
			.attr("y1", v_lines)
			.attr("y2", v_lines)
			.attr("x1", 35)
			.attr("x2", 495);


	wbchart.selectAll("text.hour")
		.data(data_hour)
		.enter()
			.append("svg:text")
			.attr("class", "hour")
			.attr("x", 0)
			.attr("y", v_lines)
			.attr("dy", 4)
			//.attr("text-anchor", "left")
			.text(function(d){ return d.toString() + 'h00'; })

	//add days text label
	wbchart.selectAll("text.day")
		.data(data_day)
		.enter()
			.append("svg:text")
			.attr("class", "day")
			.attr("x", v_days)
			.attr("y", 0)
			//.attr("dx", 4)
			//.attr("text-anchor", "right")
			.text(function(d, i){ return d; })


	var step = 10;

	wbchart.selectAll("text.dayline")
		.data(d3.range(0, 7))
		.enter()
			.append("svg:line")
			.attr("class", "dayline")
			.attr("y1", 0)
			.attr("y2", 360)
			.attr("x1", function(d) { return v_days(d) - step })
			.attr("x2", function(d) { return v_days(d) - step })
			.style("opacity", 0.5);


	wbchart.selectAll("text.dayline")
		.data(d3.range(0, 7))
		.enter()
			.append("svg:line")
			.attr("class", "dayline")
			.attr("y1", 0)
			.attr("y2", 360)
			.attr("x1", function(d) { return v_days(d) + step*3 })
			.attr("x2", function(d) { return v_days(d) + step*3 })
			.style("opacity", 0.5);

	var first_pass = true;
	var count = 1;

	function update_extinction_calendar(new_data_calendar) {

		//console.log('update_calendar '+new_data_calendar)
		//console.log(typeof(new_data_calendar))
		if (typeof(new_data_calendar) == "string") {
			//console.log("creating array")
			temp_tab=new_data_calendar.split(',');
			new_data_calendar=[{'id': temp_tab[0], 'who': temp_tab[1], 'hour': parseInt(temp_tab[2]),'day': parseInt(temp_tab[3])}];
			//console.log(new_data_calendar)
		}
		//console.log("new_data_calendar");
		//console.log(new_data_calendar);
		//console.log(new_data_calendar[0]['id'])
		if (new_data_calendar != null) {
		
			for (var j=0; j< new_data_calendar.length; j++) {
				not_merged = true
				new_rule = new_data_calendar[j];
				for (var i=0; i< data_calendar.length; i++) {

					current_rule = data_calendar[i];

					//console.log(current_rule);
					//console.log(new_rule)
					
					if (current_rule['hour'] == new_rule['hour'] && current_rule['day'] == new_rule['day']) {
						//console.log('same rule event on day '+ current_rule['day'] +' '+current_rule['start_time']);
						//console.log('going to manually concat '+new_rule['who'] + ' in ' + current_rule['who'])


						current_rule['who'] = [current_rule['who']].concat([new_rule['who']])
						current_rule['id'] = [current_rule['id']].concat([new_rule['id']])
						not_merged = false;
					}

				}
				if (not_merged) {
					//console.log("automatically merged")
					data_calendar = data_calendar.concat(new_rule);	
				}	
			}
		}		


		rect_off = wbchart.selectAll(".rect_off").data(data_calendar)
		


		rect_off.enter()
				.insert("svg:rect")
				.attr("class", "rect_off")
				.attr("x", function(d) { return v_days(d.day) - 10 })
				//.attr("y", function(d) { return v_lines(d.hour) })
				
				.attr("width", 40)
				.transition()
					.duration(transition_delay)
						.attr("height", function(d) { return v_lines(22) - v_lines(d.hour) })
						.attr("y", function(d) { return v_lines(d.hour) })
						
				//.attr("width", avg_chart_x);;

		rect_off.transition()
			.duration(transition_delay)
				.attr("x", function(d) { return v_days(d.day) - 10 })
				.attr("y", function(d) { return v_lines(d.hour)  })
				.attr("width", 40)
				.attr("height", function(d) { return v_lines(22) - v_lines(d.hour) });
		
		rect_off.exit().remove()


		//on
		rect_on = wbchart.selectAll(".rect_on").data(data_calendar)
		
		rect_on.enter()
				.append("svg:rect")
				.attr("class", "rect_on")
				.attr("x", function(d) { return v_days(d.day) - 10 })
				
				.attr("width", 40)
				.transition()
					.duration(transition_delay)
						.attr("height", function(d) { return v_lines(d.hour); })
						.attr("y", function(d) { return 7; });

				//.on("mouseover", fade(.1))
				//.on("mouseout", fade(1)); 
		
		rect_on.transition()
			.duration(transition_delay)
				
				.attr("x", function(d) { return v_days(d.day) - 10 })
				.attr("y", function(d) { return 7; })
				.attr("width", 40)
				.attr("height", function(d) { return v_lines(d.hour); });
		
		rect_on.exit().remove()



		// draw separators		
		separators = wbchart.selectAll(".rect_sep").data(
			data_calendar)

		
		//console.log("data_calendar");
		//console.log(data_calendar);

		separators.enter()
				.insert("svg:rect")
				.attr("class", "rect_sep")
				.attr("x", function(d) { return v_days(d.day) - 15 })
				//.attr("y", function(d) { return v_lines(d.hour) })
				.attr("width", 50)
				.attr("height", 5)
				.transition()
					.duration(transition_delay)
						//.attr("height", 5)
						.attr("y", function(d) { return v_lines(d.hour) })
				
		//separators.on("mouseover", show_group(d));		
		separators.transition()
			.duration(transition_delay)
				.attr("y", function(d, i) { return v_lines(d.hour); })
				.attr("x", function(d, i) { return v_days(d.day) - 15; });

		separators.exit()
			.transition()
				.attr("y", function(d, i) { return v_lines(d.hour); })
			.remove();	





		
	
		$('svg .rect_sep').tipsy({ 
	    	gravity: 's', 
	    	html: true, 
	    	title: function() {
	    		var d = this.__data__, g = d.who;
	    		return 'Extinction of '+ g; 
	    	   }
	    });


	    
	}

	// at the first launch, import already existing rules 
	//update_extinction_calendar({{ calendar_rules }})




	
	weekly_bars_is_ready = true;
	
	 
	function show_group(d) {
		//console.log("hover");
		 wbchart.selectAll(".rect_sep")
		     .filter(function(d) {
		     	console.log("ddd = ");
		     	console.log(d)
		       return d;
		    })
		   .transition()
		     .style("height", 10);
		
	}

	function fade(opacity) {
		//console.log("hover");
		return function(g, i) {
			console.log("tototototoo")
		 wbchart.selectAll(".rect_off")
		     .filter(function(d) {
		     	console.log("ddd = " + d);
		     	console.log(d);
		       return d;
		    })
		   .transition()
		     .style("opacity", opacity);
		};
	}
	*/
</script>

