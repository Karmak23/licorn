{#- Copyright 2012 META IT & Olivier Cortès <olive@licorn.org>
    Distributed under the terms of the GNU GPL version 2. -#}

{%- extends 'base.bootstrap.html' -%}

{% block extended_media %}
	<script type="text/javascript" src="/media/js/jquery.zclip.min.js"></script>
{% endblock %}

{% block title %}{{ _('Web share {0}').format(share.name) }}{% endblock %}

{%- block container -%}
<div class="row">

	<div class="span5 offset3 alert alert-success">
		<div class="centered" title="{{ _('Click the button to copy the URL to clipboard') }}">
			{{ _('Public link for this share:') }}
				<a id="copy_url" href="#" class="btn btn-success">{{ share.uri }}</a>
				<div id="copy_message_success" class="hidden">{{ _('Successfully copied to clipboard!') }}</div>
				<script>
					function success_message() {
						setTimeout(function(){
							$('#copy_message_success').slideDown('fast');
							setTimeout(function(){
								$('#copy_message_success').slideUp('slow');
							}, 2000);
						}, 150);
					}

					function setup_zclip(){

						$('a#copy_url').zclip({
							path:'/media/images/ZeroClipboard.swf',
							copy:$('a#copy_url').text(),
							beforeCopy:success_message,
							afterCopy:function(){
								$("#copy_message_success").focus();


								// remove zclip to restore normal focus,
								// else flash grabs it eternally.
								$('a#copy_url').zclip('remove');

								// restore zclip afterwards for the copy
								// mechanism to continue working.
								setTimeout(setup_zclip, 50);
								return true;
							},
						});
					}

					setup_zclip();
					/*
						beforeCopy:function(){
							$('#callback-paragraph').css('background','yellow');
							$(this).css('color','orange');
						},
					*/
				</script>
		</div>
	</div>

	<div class="span8 offset2">
		{%- if request.user.is_authenticated()
						and request.user.username == share.coreobj.name -%}

			<a href="{{ url_for('wmi.shares.views.index') }}"
				class="btn pull-right">
				{{ _('Configure your share&nbsp;&raquo;') }}
			</a>

		{%- endif -%}

		<h1>{{ _('Welcome to share <em>{0}</em>').format(share.name) }}</h1>
	</div>

	{%- set contents_numbers = share.contents() -%}

	{%- if share.accepts_uploads -%}

		<div class="span6 offset2 hero-unit">
		<h2>{{ _('Uploaded documents') }}</h2>
		<div class="span2 offset4">
				<a href="#" class="btn btn-primary btn-large">
					{{ _('Upload a document &raquo;')}}</a>
		</div>
		<p>
			{%- if contents_numbers.uploads -%}
				{{ _('Contains {0} uploaded documents').format(contents_numbers.uploads) }}
			{%- else -%}
				{{ _('No documents uploaded') }}
			{%- endif -%}
		</p>
		</div>

	{# else:
		We choose not to display a message in case the owner doesn't accept
		uploads on this share. This could just frustrate the visitor. #}
	{%- endif -%}

	{%- if contents_numbers.files -%}

	<p>&nbsp;</p>
	<p class="span8 offset2">{{ _('Click on a filename to download it to your computer:') }}</p>

		{%- set contents = share.contents(with_paths=True) -%}
		<div class="span8 offset2">
		<table class="table table-striped">
			<tr>
				<th>{{_('File name')}}</th>
				<th>{{_('Size')}}</th>
				<th>{{_('Last modified')}}</th>
				<th>{{_('Type')}}</th>
			</tr>

			{%- for filename in contents.files|sort -%}
				{%- set infos     = share.file_informations(filename) -%}
				{%- set pub_fname = filename.replace(share.path, '')[1:] -%}
				<tr>
					<td class="nowrap"><i class="icon-file"></i> <a href="{{
								url_for('wmi.shares.views.download',
								args=(share.coreobj.name, share.name, pub_fname))}}">{{ pub_fname }}</a></td>
					<td>{{ bytes_to_human(infos.size) }}</td>
					<td>{{ format_time_delta(infos.mtime, use_neg=True, long_output=False) }}</td>
					<td>{{ infos.mimetype }}</td>
				</tr>

			{%- endfor -%}
		</table>
		</div>
	{%- else -%}

		<div class="span12">&nbsp;</div>
		<div class="hero-unit span6 offset2">
			<h2>{{ _('No shared document') }}</h2>
			<p>{{ _('Ask the person who sent you here to populate his share directory. Perhaps he has forgotten?') }}</p>
		</div>
	{%- endif -%}
</div>
{% endblock %}
