{#- Copyright 2011 META IT, Olivier Cort√®s <oc@meta-it.fr>, Robin Lucbernet<rl@meta-it.fr>
    Distributed under the terms of the GNU GPL version 2. -#}





{%- extends 'modal.html' -%}

    {%- block title -%}
	    {%- if mode == 'new' -%}
	    	<h3>{{ _('New user') }}</h3>
	    {%- elif mode == 'edit' -%}
	    	<h3>{{ _('Edit user') }} {{ '<span>{0}</span>'.format(user.login) }}</h3>
	    {%- elif mode == 'massiv' -%}
	    	<h3>{{ _('Massive user edition') }}</h3>
	    {%- endif -%}
    {%- endblock -%}


  {%- block body -%}

  	{% if form.errors and not form.non_field_errors() -%}
	    <div class="error_div error_text">
			{% trans count=form.errors.items()|length() %}
			    Merci de corriger l'erreur ci-dessous&nbsp;:
			{% pluralize %}
			    Merci de corriger les erreurs suivantes&nbsp;:
			{% endtrans %}
	    </div>
	{% endif -%}

	{% if form.non_field_errors() %}
	    {% for error in form.non_field_errors() %}
			<p class="errornote">
				{{ error }}
			</p>
	    {% endfor %}
	{% endif %}

	<form class="form-horizontal" id='user_form'>

		{% csrf_token %}
		




	<ul class="nav nav-tabs" id="myTab">
		{% for block in form_blocks %}
			<li {{ 'class="active"' if form_blocks[block][2] }}><a href="#{{ form_blocks[block][0] }}" data-toggle="tab">{{ form_blocks[block][1] }}</a></li>
		{% endfor %}
	</ul>
	<div class="tab-content">


	<div class="tab-pane active" id="general">

		<div class="control-group">
			{% for field in form.visible_fields() %}
			<div style="min-height:40px;">
				<label class="control-label" for="id_{{ field.name }}">
					{{ field.label }}
					{%-if field.field.required -%}
						&nbsp;
						<span class="required_field">*</span>
					{%- endif -%}
				</label>
				<div class="controls" style="vertical-align:center;">
					{{ field }}

					{%-if field.field.help_text -%}
						<p class="help-block">{{ field.field.help_text }}</p>
					{%- endif -%}
				</div>
			</div>
			{% endfor %}
			{% if mode == 'edit' %}
		<a href="#" class="btn btn-danger btn-block" id="delete_user_button" data-id='{{user.uid}}'>{{ _('Delete user') }}</a>
	{% endif %}
		</div>
		
	</div>
	
		
	{# add users and sys_user pane #}

	{%- for list in groups_lists -%}
		<div class="tab-pane" id="{{ list.list_name }}">
			<div>
				<div style="text-align:right;margin-bottom:20px;">
					{{ _('Sort by:') }}
					<span class="btn-group" data-toggle="buttons-radio">
						<button type="button" id='sort_alpha' class="btn sort_item" data-sort="alpha" data-id="{{ list.list_name }}">
							{{ _("Group name") }}
						</button>
						<button type="button" id='sort_relation' class="btn sort_item" data-sort="relation" data-id="{{ list.list_name }}">
							{{ _("Relationship") }}
						</button>
						
					

					</span>
				</div>
				{{list.list_content}}
			</div>
    	</div>
	{%- endfor -%}


	</div> <!-- end tab-content -->
	



	</form>


  {%- endblock -%}
  {%- block footer -%}
  	<a href="#" class="btn" data-dismiss="modal">{{ _('Fermer') }}</a>
    {% if mode == "new" %}
    <a href="#" class="btn btn-primary" id="save_group_button">{{ _('Add group') }}</a>

    {%endif%}


    <style>
    	.my_popover{
    		width:auto;
    	}
    </style>
    <script type="text/javascript">
	var tab_sort = { "alpha": true, "relation": false}
	

	$(document).ready(function() {
		
		// .click_item are our user box, when click is triggered, 
		// show the popover containing possible relationship

		setup_sort_items('.trigger_popover', $('.sort_item'));

		function setup_sort_items(elements, sort_items) {
			console.log('setup_sort_items', elements, sort_items)

			$.each(sort_items, function(i, item) {
				console.log(item, tab_sort, $(item).data('sort'))
				// setup interface
				if (tab_sort[$(item).data('sort')]) {
					$(item).addClass('active')
				}
				else {
					$(item).removeClass('active')
				}
			})
			$(sort_items).click(function(e) {
				
				do_sort($(this).data('id'), $(this).data('sort'));

			})
			//do_sort();

			function do_sort(div, sort_item) {
				console.log("do_sort")
				tab = $('#'+div+' '+elements)
				console.log($(tab))
				tab.sort(function(a, b) {
					//console.log($(a).data('rel'), $(b).data('rel'))
					if (sort_item == 'alpha') {
						if ($(a).find('.group_name').text().toLowerCase() < $(b).find('.group_name').text().toLowerCase()) {
							return -1
						}
						else if ($(a).find('.group_name').text().toLowerCase() > $(b).find('.group_name').text().toLowerCase()) {
							return 1
						}
						else {
							return 0
						}
					}
					else if (sort_item == 'relation') {
						return ($(a).data('rel') - $(b).data('rel'))
					}
				})
				if (sort_item == 'relation') {
					$.fn.reverse = [].reverse;
					tab = tab.reverse();
				}
				console.log('sorted', $(tab))

				//$.each(tab, function(i, item) {
				//	console.log($(item))
				//})

				$('#'+div+' '+elements).hide()
				$.each(tab, function(i, item) {
					$('#'+div).append($(item))
				})

				$('#'+div+' '+elements).show()






			}

		}































		// init the popover
		$('.trigger_popover').each(function() {

			// display only relevant relationship (do not display the current one)
			current_rel = $(this).data('rel')
			$(this).find('.rel_'+current_rel).hide();
			var popover_id = $(this).data('id')

			// init tht popover
			$(this).clickover({
				title : 'relationship',
				content  : function() { return $(this).find('.popover').html();},
				html: true,
				placement : 'top',
				template: '<div class="popover my_popover" id="popover_'+popover_id+'"><div class="arrow"></div><div class="popover-inner"><div class="popover-content"><p></p></div></div></div>'

			}).click(function() {

				// on popover display, initialize instant_click, if 'edit' or 'massiv' mode
				{% if mode == 'edit' or mode == 'massiv' %}
					console.log('inti',popover_id, $("#popover_"+$(this).data('id')))
					init_instant_click($("#popover_"+$(this).data('id')))
				{% elif mode == 'new' %}
					{# no instant apply, but give a visual feedback #}
					$('#popover_'+$(this).data('id')+' .instant_click').click(function() {
						update_relationship($(this).data('id'), $(this).data('relid'))
					});
				{% endif -%}
			});
		});

		



		

		{%- if mode == 'new' -%}
			
			function post_form() {
				console.log(typeof($('#user_form').serialize()))
				var serialized_form = $('#user_form').serialize()

				//console.log(serialized_form)

				$.each($('form .trigger_popover'), function() {
					
					rel = $(this).attr('data-rel')
					
					if (rel == "0") {
						serialized_form += "&no_membership_users="+$(this).data('id')
					}
					else if (rel == "1") {
						serialized_form += "&guest_users="+$(this).data('id')
					}
					else if (rel == "2") {
						serialized_form += "&member_users="+$(this).data('id')
					}
					else if (rel == "3") {
						serialized_form += "&resp_users="+$(this).data('id')
					}
					
				})

				//console.log(serialized_form)
				$.post("/groups/create/", serialized_form);

				$('#modal').modal('hide')
			};

			$(document).keyup(function(e) {
				if (e.keyCode == 13) { // enter
					post_form();
				}
			});

			// click save button
			$('#save_group_button').click( function() {
				$('#save_group_button').unbind('click');
				post_form();
			});
			

			$('#modal').modal('hide');

			
		{%- endif -%}

		$('#id_permissive').checkbox({
	        'on_text': "{{ _('No') }}",
	        'off_text' : "{{ _('Yes') }}"
	    })

	    $('#delete_group_button').click( function() {
				
				$('#groups_'+$(this).data('gid')).addClass(select_active_class)
				$('#massive_delete').trigger('click');

			});



	});
</script>



    
  {%- endblock -%}





































